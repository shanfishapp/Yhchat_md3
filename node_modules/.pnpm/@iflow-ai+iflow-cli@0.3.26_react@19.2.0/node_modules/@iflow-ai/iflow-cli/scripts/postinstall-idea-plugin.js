/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

import { existsSync, mkdirSync, createWriteStream, statSync, readdirSync, createReadStream, unlinkSync, rmSync } from 'fs';
import { join, dirname, resolve } from 'path';
import { fileURLToPath } from 'url';
import os from 'os';
import https from 'https';
import http from 'http'; // 添加HTTP模块导入
import { createHash } from 'crypto';
import { pipeline } from 'stream/promises';
import { Extract } from 'unzipper';

// 常量定义
const PLUGIN_URL = 'https://cloud.iflow.cn/iflow-cli/idea-plugin/iflow-idea-0.0.3.zip';
const PLUGIN_DIR_NAME = 'iflow-idea';
const TEMP_DIR_NAME = 'tstar-cli-idea-plugin';
const LOG_PREFIX = '[JetBrains Extension]';
// 扩展支持的JetBrains IDE产品
const IDE_PATTERNS = [
  'IntelliJIdea', 'IdeaIC',  // IntelliJ IDEA
  'PyCharm', 'PyCharmCE',    // PyCharm
  'GoLand',                  // GoLand
  'WebStorm',                // WebStorm
  'PhpStorm',                // PhpStorm
  'CLion',                   // CLion
  'RubyMine',                // RubyMine
  'DataGrip',                // DataGrip
  'Rider',                   // Rider
  'AndroidStudio'            // Android Studio
];

// 获取当前脚本的目录
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// 验证路径是否安全
function validatePath(path) {
  if (!path || typeof path !== 'string') {
    return false;
  }

  // 防止路径遍历攻击
  const normalizedPath = resolve(path);
  return !normalizedPath.includes('..');
}

// 检查文件是否存在且可执行
function isExecutable(filePath) {
  try {
    const stats = statSync(filePath);
    return stats.isFile() && (stats.mode & parseInt('111', 8)) !== 0;
  } catch {
    return false;
  }
}

// 获取 JetBrains IDE 插件目录的跨平台函数
function getJetBrainsPluginsDirectory() {
  const platform = os.platform();
  const homedir = os.homedir();

  switch (platform) {
    case 'darwin': // macOS
      return join(homedir, 'Library', 'Application Support', 'JetBrains');
    case 'win32': // Windows
      return join(homedir, 'AppData', 'Roaming', 'JetBrains');
    case 'linux': // Linux
      return join(homedir, '.local', 'share', 'JetBrains');
    default:
      throw new Error(`Unsupported platform: ${platform}`);
  }
}

// 查找最新版本的 JetBrains IDE 目录
function findLatestJetBrainsDirectories() {
  const jetbrainsDir = getJetBrainsPluginsDirectory();

  if (!existsSync(jetbrainsDir)) {
    console.warn(`${LOG_PREFIX} JetBrains directory not found:`, jetbrainsDir);
    return [];
  }

  try {
    // 获取所有匹配的IDE目录，并按修改时间排序
    const dirs = readdirSync(jetbrainsDir)
      .filter(dir => IDE_PATTERNS.some(pattern => dir.startsWith(pattern)))
      .map(dir => {
        const fullPath = join(jetbrainsDir, dir);
        try {
          const stats = statSync(fullPath);
          return { path: fullPath, mtime: stats.mtime, name: dir };
        } catch (error) {
          console.warn(`${LOG_PREFIX} Cannot access directory ${fullPath}:`, error.message);
          return null;
        }
      })
      .filter(Boolean)
      .sort((a, b) => b.mtime - a.mtime);

    if (dirs.length === 0) {
      console.warn(`${LOG_PREFIX} No JetBrains IDE installation found`);
      return [];
    }

    // 按IDE类型分组，每种IDE只保留最新版本
    const latestByType = {};
    dirs.forEach(dir => {
      const ideType = IDE_PATTERNS.find(pattern => dir.name.startsWith(pattern));
      if (ideType && !latestByType[ideType]) {
        latestByType[ideType] = dir;
      }
    });

    return Object.values(latestByType);
  } catch (error) {
    console.error(`${LOG_PREFIX} Error finding JetBrains IDE directories:`, error.message);
    return [];
  }
}

// 下载插件
async function downloadPlugin(url, destPath) {
  return new Promise((resolve, reject) => {
    const file = createWriteStream(destPath);

    // 根据URL协议选择适当的模块
    const protocol = url.startsWith('https:') ? https : http;

    protocol.get(url, (response) => {
      if (response.statusCode !== 200) {
        reject(new Error(`Failed to download plugin: ${response.statusCode}`));
        return;
      }

      pipeline(response, file)
        .then(() => resolve())
        .catch(reject);
    }).on('error', (err) => {
      reject(err);
    });
  });
}

// 计算文件的 SHA-256 哈希值
async function calculateFileHash(filePath) {
  return new Promise((resolve, reject) => {
    try {
      const hash = createHash('sha256');
      const stream = createReadStream(filePath);

      stream.on('data', (data) => hash.update(data));
      stream.on('end', () => resolve(hash.digest('hex')));
      stream.on('error', reject);
    } catch (error) {
      reject(error);
    }
  });
}

// 解压插件
async function extractPlugin(zipFilePath, destDir) {
  return new Promise((resolve, reject) => {
    createReadStream(zipFilePath)
      .pipe(Extract({ path: destDir }))
      .on('close', () => resolve())
      .on('error', (err) => reject(err));
  });
}

// 安装 JetBrains IDE 插件
async function installJetBrainsExtension() {
  try {
    // 查找所有支持的 JetBrains IDE 目录
    const ideDirs = findLatestJetBrainsDirectories();
    if (ideDirs.length === 0) {
      console.warn(`${LOG_PREFIX} Could not find any JetBrains IDE installation, skipping plugin installation`);
      return;
    }

    // 创建临时下载目录
    const tempDir = join(os.tmpdir(), TEMP_DIR_NAME);
    if (!existsSync(tempDir)) {
      try {
        mkdirSync(tempDir, { recursive: true });
      } catch (error) {
        console.error(`${LOG_PREFIX} Failed to create temporary directory: ${tempDir}`, error.message);
        return;
      }
    }

    // 生成唯一的文件名
    const pluginFileName = `tstar-idea-plugin-${Date.now()}.zip`;
    const pluginFilePath = join(tempDir, pluginFileName);

    console.info(`${LOG_PREFIX} Downloading plugin from: ${PLUGIN_URL}`);

    try {
      // 下载插件
      await downloadPlugin(PLUGIN_URL, pluginFilePath);
      console.info(`${LOG_PREFIX} Plugin downloaded to: ${pluginFilePath}`);

      // 计算插件文件哈希值，用于验证下载是否完整
      const fileHash = await calculateFileHash(pluginFilePath);
      console.info(`${LOG_PREFIX} Plugin file hash: ${fileHash}`);

      // 为每个找到的IDE安装插件
      for (const ideDir of ideDirs) {
        console.info(`${LOG_PREFIX} Found JetBrains IDE at: ${ideDir.path}`);

        // 创建插件目录路径
        const pluginsDir = join(ideDir.path, 'plugins');
        if (!existsSync(pluginsDir)) {
          try {
            mkdirSync(pluginsDir, { recursive: true });
          } catch (error) {
            console.error(`${LOG_PREFIX} Failed to create plugins directory: ${pluginsDir}`, error.message);
            continue; // 跳过此IDE，继续下一个
          }
        }

        // 检查并删除已存在的插件目录
        const existingPluginDir = join(pluginsDir, PLUGIN_DIR_NAME);
        if (existsSync(existingPluginDir)) {
          try {
            console.info(`${LOG_PREFIX} Removing existing plugin directory: ${existingPluginDir}`);
            rmSync(existingPluginDir, { recursive: true, force: true });
          } catch (error) {
            console.error(`${LOG_PREFIX} Failed to remove existing plugin directory: ${existingPluginDir}`, error.message);
            // 继续安装，即使删除失败
          }
        }

        // 解压插件到插件目录
        console.info(`${LOG_PREFIX} Extracting plugin to: ${pluginsDir}`);

        try {
          // 直接解压到插件目录，不创建额外的子目录
          await extractPlugin(pluginFilePath, pluginsDir);
          console.info(`${LOG_PREFIX} ✅ Plugin installed successfully to: ${pluginsDir}`);
        } catch (error) {
          console.error(`${LOG_PREFIX} Failed to install plugin for ${ideDir.name}:`, error.message);
        }
      }

      // 清理临时文件
      try {
        unlinkSync(pluginFilePath);
      } catch (error) {
        console.warn(`${LOG_PREFIX} Failed to clean up temporary file: ${pluginFilePath}`, error.message);
      }

    } catch (error) {
      console.error(`${LOG_PREFIX} Failed to install plugin:`, error.message);
      console.debug(`${LOG_PREFIX} Stack trace:`, error.stack);
    }
  } catch (error) {
    console.error(`${LOG_PREFIX} Unexpected error during JetBrains extension installation:`, error.message);
    console.debug(`${LOG_PREFIX} Stack trace:`, error.stack);
  }
}

// 只在非 CI 环境执行
if (!process.env.CI) {
  installJetBrainsExtension().catch(error => {
    console.error(`${LOG_PREFIX} Installation failed:`, error.message);
  });
}
